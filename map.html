<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>ä½æ‰€å…¥åŠ›ã§åœ°å›³ç§»å‹•ï¼‹ãƒ”ãƒ³è¿½åŠ </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 16px; }
    #controls { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; align-items: center; }
    #addr { flex: 1; min-width: 240px; padding: 8px; }
    button { padding: 8px 12px; }
    #map { width: 100%; height: 520px; margin: 10px 0; }
    #msg { margin-top: 6px; color: #d00; font-size: 14px; min-height: 1em; }

    .btn-row {
      margin: 8px 0;      /* è¡Œã®ä¸Šä¸‹ã®ã™ãé–“ */
      display: flex;
      gap: 6px;           /* ãƒœã‚¿ãƒ³é–“ã®ã™ãé–“ */
      flex-wrap: wrap;    /* ã¯ã¿å‡ºãŸã‚‰æŠ˜ã‚Šè¿”ã— */
    }
  </style>
</head>
<body>
  <h3>ãƒœã‚¿ãƒ³ã§ç§»å‹•ï¼‹å³ã‚¯ãƒªãƒƒã‚¯ã§ãƒ”ãƒ³ï¼‹ä½æ‰€å…¥åŠ›ã§ç§»å‹•</h3>

  <!-- ä½æ‰€å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div id="controls">
    <input id="addr" placeholder="ä¾‹ï¼šæ±äº¬é§… / å¤§é˜ªå¸‚åŒ—åŒº / 100-0005">
    <button id="go">ç§»å‹•</button>
    <button id="clear">ãƒ”ãƒ³ã‚’å…¨éƒ¨æ¶ˆã™</button>
  </div>

  <!-- åœ°å›³ -->
  <div id="map"></div>

  <!-- å›ºå®šã®ç§»å‹•ãƒœã‚¿ãƒ³ï¼ˆãƒªã‚»ãƒƒãƒˆä»£ã‚ã‚Šï¼‰ -->
  <div class="btn-row">
    <button onclick="moveTo(35.681236, 139.767125, 'ğŸ“æ±äº¬é§…')">æ±äº¬é§…</button>
    <button onclick="moveTo(34.693738, 135.502165, 'ğŸ“å¤§é˜ªé§…')">å¤§é˜ªé§…</button>
    <button onclick="moveTo(35.170915, 136.881537, 'ğŸ“åå¤å±‹é§…')">åå¤å±‹é§…</button>
 </div>

  <div class="btn-row">
    <button onclick="removeLastPin()">æœ€å¾Œã®ãƒ”ãƒ³ã‚’å‰Šé™¤</button>
    <button onclick="clearPins()">å…¨éƒ¨ã®ãƒ”ãƒ³ã‚’å‰Šé™¤</button>
  </div>

  <div id="msg" aria-live="polite"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ===== åœ°å›³åˆæœŸåŒ– =====
    const map = L.map('map').setView([35.681236, 139.767125], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OpenStreetMap</a> contributors'
     }).addTo(map);

    L.control.scale({ imperial: false }).addTo(map);

    // åˆæœŸã®åŸºæº–ãƒ”ãƒ³ï¼ˆæ±äº¬é§…ï¼‰
    let mainMarker = L.marker([35.681236, 139.767125]).addTo(map).bindPopup('ğŸ“æ±äº¬é§…').openPopup();

    // å³ã‚¯ãƒªãƒƒã‚¯ã§ãƒ”ãƒ³è¿½åŠ ï¼ˆè¤‡æ•°ï¼‰
    let markers = [];
    map.on('contextmenu', function(e) {
      const lat = e.latlng.lat.toFixed(6);
      const lng = e.latlng.lng.toFixed(6);
      const m = L.marker([lat, lng]).addTo(map).bindPopup('ğŸ“ãƒ”ãƒ³ã‚’ç«‹ã¦ã¾ã—ãŸ<br>ç·¯åº¦:' + lat + '<br>çµŒåº¦:' + lng).openPopup();
      markers.push(m);
      console.log('ãƒ”ãƒ³è¿½åŠ ï¼š' + lat + ', ' + lng);
    });

    // å›ºå®šãƒœã‚¿ãƒ³ã§ç§»å‹•ï¼ˆåŸºæº–ãƒ”ãƒ³ã‚’å‹•ã‹ã™ï¼‰
    function moveTo(lat, lng, label) {
      map.setView([lat, lng], 13);
      mainMarker.setLatLng([lat, lng]).setPopupContent(label).openPopup();
    }

    // æœ€å¾Œã®ãƒ”ãƒ³ã‚’å‰Šé™¤
    function removeLastPin() {
      const last = markers.pop();
      if (last) {
        map.removeLayer(last);
      } else {
        alert('å‰Šé™¤ã§ãã‚‹ãƒ”ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ï¼');
      }
    }

    // å…¨éƒ¨ã®ãƒ”ãƒ³ã‚’å‰Šé™¤
    function clearPins() {
      markers.forEach(function(m) { map.removeLayer(m); });
      markers = [];
    }

    // ===== ä½æ‰€å…¥åŠ› â†’ ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° â†’ åœ°å›³ç§»å‹•ï¼†ãƒ”ãƒ³ =====
    const input = document.getElementById('addr');
    const btnGo = document.getElementById('go');
    const btnClear = document.getElementById('clear');
    const msg = document.getElementById('msg');

    btnGo.addEventListener('click', function () { geocodeAndMove(); });
    input.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        geocodeAndMove();
      }
    });
    btnClear.addEventListener('click', function () { clearPins(); msg.textContent = ''; });

    async function geocodeAndMove() {
      const q = input.value.trim();
      msg.textContent = '';
      if (q.length === 0) {
        msg.textContent = 'ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        return;
      }

      btnGo.disabled = true;
      btnGo.textContent = 'æ¤œç´¢ä¸­â€¦';

      try {
        // Nominatimï¼ˆOpenStreetMapã®ã‚¸ã‚ªã‚³ãƒ¼ãƒ€ï¼‰
        const url = 'https://nominatim.openstreetmap.org/search'
         + '?format=json'
         + '&limit=1'
         + '&countrycodes=jp'
         + '&q=' + encodeURIComponent(q); + encodeURIComponent(q);

        const res = await fetch(url, { headers: { 'Accept-Language': 'ja' } });
        if (!res.ok) {
          msg.textContent = 'æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŸã‚ã—ã¦ãã ã•ã„ã€‚';
          btnGo.disabled = false; btnGo.textContent = 'ç§»å‹•';
          return;
        }
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0) {
          msg.textContent = 'è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰ãˆã¦ãã ã•ã„ã€‚ï¼ˆä¾‹ï¼šéƒµä¾¿ç•ªå·ã€åŒºå¸‚ç”ºæ‘åï¼‰';
          btnGo.disabled = false; btnGo.textContent = 'ç§»å‹•';
          return;
        }

        const first = data[0];
        const lat = parseFloat(first.lat);
        const lon = parseFloat(first.lon);
        const label = first.display_name;

        // åœ°å›³ç§»å‹•ï¼ˆã‚ºãƒ¼ãƒ å°‘ã—å¯„ã›ã‚‹ï¼‰
        map.setView([lat, lon], 16);

        // ãƒ”ãƒ³ã‚’è¿½åŠ ï¼ˆå‰Šé™¤ãƒœã‚¿ãƒ³ã§æ¶ˆã›ã‚‹ã‚ˆã†é…åˆ—ã«å…¥ã‚Œã‚‹ï¼‰
        const gm = L.marker([lat, lon]).addTo(map).bindPopup('ğŸ“ ' + label).openPopup();
        markers.push(gm);

      } catch (err) {
        console.error(err);
        msg.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ã”ç¢ºèªãã ã•ã„ã€‚';
      } finally {
        btnGo.disabled = false;
        btnGo.textContent = 'ç§»å‹•';
      }
    }
  </script>
</body>
</html>
